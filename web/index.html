<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KENIA | Dashboard</title>
  <link rel="icon" type="image/x-icon" href="/logotipo-VCMAS.ico" />
  <link rel="stylesheet" href="/styles.css" />
  <!-- mammoth.js for Word (.docx) parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
</head>

<body>
  <main class="layout">
    <section class="panel">

      <!-- HEADER -->
      <div class="app-header">
        <div class="app-logo">ğŸ“¡</div>
        <div class="app-title">
          <h1>KENIA Dashboard</h1>
          <p>Control remoto de llamadas desde el navegador</p>
        </div>
      </div>

      <!-- APK MANAGEMENT BAR -->
      <div id="apkBar" class="apk-bar">
        <div class="apk-info">
          <img class="apk-icon-img" src="/logotipo-VCMAS.ico" alt="VC icono" width="22" height="22" />
          <div>
            <strong id="apkName">Phone-VC Android</strong>
            <small id="apkMeta" class="muted">Cargando info del APKâ€¦</small>
          </div>
        </div>
        <div class="apk-actions">
          <select id="apkVersionSelect" class="apk-version-select" title="Seleccionar versiÃ³n APK">
            <option value="">Versiones...</option>
          </select>
          <a id="apkDownloadBtn" href="/api/apk/download" class="btn-apk-dl" download>
            â¬‡ï¸ Descargar APK
          </a>
          <button id="apkInstallHelp" class="secondary" style="font-size:12px;min-height:34px;padding:0 12px;">
            â“ CÃ³mo instalar
          </button>
        </div>
      </div>

      <!-- INSTALL GUIDE (collapsible) -->
      <div id="installGuide" class="install-guide" style="display:none">
        <ol>
          <li>Descarga el APK con el botÃ³n de arriba.</li>
          <li>En Android: <strong>Ajustes â†’ Seguridad â†’ Instalar apps desconocidas</strong> â†’ Activar para tu navegador.
          </li>
          <li>Abre el archivo descargado e instala.</li>
          <li>Abre <strong>Phone-VC</strong>, escanea el QR o ingresa el cÃ³digo de sesiÃ³n.</li>
          <li>Activa <strong>Phone-VC como marcador por defecto</strong> dentro de la app para poder colgar llamadas.
          </li>
        </ol>
      </div>

      <!-- SESSION BAR -->
      <div id="sessionBar" class="session-bar">
        <button id="createSession">ï¼‹ Crear SesiÃ³n</button>
        <input id="sessionCode" placeholder="CÃ“DIGO (6 chars)" maxlength="8" style="text-transform:uppercase;" />
        <button id="joinSession" class="secondary">Vincular</button>
      </div>

      <!-- STATUS -->
      <div class="status-pill" id="status">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Sin vincular. Crea o une a una sesiÃ³n.</span>
      </div>

      <!-- LINKED BANNER -->
      <div id="linkedBanner" class="linked-banner" style="display:none">
        <div>
          <strong>ğŸ“± Celular vinculado</strong>
          <span id="linkedDevice" style="display:block;font-size:13px;margin-top:3px;">Dispositivo conectado</span>
        </div>
        <span style="color:#a78bfa;font-size:22px;">âœ…</span>
      </div>

      <!-- QR BLOCK -->
      <div class="qr-block" id="qrBlock">
        <div>
          <p class="muted" style="font-size:13px;margin-bottom:8px;">QR de vinculaciÃ³n (Android)</p>
          <img id="pairQr" alt="QR de vinculacion" style="display:none" />
          <small id="qrHint" class="muted">Crea una sesiÃ³n para ver el QR.</small>
        </div>
        <div class="pairing-data">
          <label class="muted" style="font-size:12px;">Link de vinculaciÃ³n</label>
          <input id="pairLink" readonly placeholder="AparecerÃ¡ al crear sesiÃ³n" />
          <button id="copyPairLink" class="secondary">ğŸ“‹ Copiar link</button>
        </div>
      </div>

      <!-- CONTACTS SECTION -->
      <section id="contactsSection" style="display:none">
        <p class="section-title">ğŸ“‹ Contactos</p>
        <div class="row" style="margin-top:0;">
          <button id="exportWordBtn" class="secondary">ğŸ“„ Exportar Word</button>
          <button id="openQuotationBtn">ğŸ§¾ Nueva CotizaciÃ³n</button>
          <button id="connectWhatsAppBtn" class="secondary">ğŸŸ¢ Conectar WhatsApp</button>
        </div>

        <!-- ADD MANUALLY -->
        <div id="contactInlineRow" class="row">
          <input id="contactName" placeholder="Nombre" />
          <input id="contactPhone" placeholder="+51999999999" style="font-family:monospace;" />
          <input id="contactNote" placeholder="Nota (opcional)" list="noteOptions" />
          <button id="addContact">ï¼‹ Agregar</button>
        </div>

        <!-- IMPORT PANEL -->
        <div class="import-panel">
          <p class="section-title" style="margin-top:0;">ğŸ“¥ Importar contactos</p>

          <div class="import-tabs">
            <button id="tabWord" class="import-tab active" data-tab="word">ğŸ“„ Word / Excel</button>
            <button id="tabUrl" class="import-tab" data-tab="url">ğŸŒ Desde URL</button>
          </div>

          <!-- WORD IMPORT -->
          <div id="importPanelWord" class="import-body">
            <p class="muted" style="font-size:12px;margin-bottom:8px;">
              Sube un archivo <strong>.docx</strong>, <strong>.xlsx</strong> o <strong>.csv</strong>.
              Se detectarÃ¡n columnas: <em>Nombre / Name, TelÃ©fono / Phone / Tel / Celular, Nota</em>.
            </p>
            <div class="row" style="align-items:center;">
              <label class="file-label" for="importFile">
                ğŸ“‚ Seleccionar archivo
                <input id="importFile" type="file" accept=".docx,.csv,.txt,.xlsx" hidden />
              </label>
              <span id="importFileName" class="muted" style="font-size:13px;">Ninguno seleccionado</span>
            </div>
          </div>

          <!-- URL IMPORT -->
          <div id="importPanelUrl" class="import-body" style="display:none">
            <p class="muted" style="font-size:12px;margin-bottom:8px;">
              Pega una URL de pÃ¡gina web con tabla o lista de contactos. Se detectarÃ¡n cabeceras automÃ¡ticamente.
            </p>
            <div class="row">
              <input id="importUrl" placeholder="https://..." style="flex:1;min-width:200px;" />
              <button id="importUrlBtn">ğŸ” Importar</button>
            </div>
          </div>

          <!-- PREVIEW -->
          <div id="importPreview" style="display:none;margin-top:12px;">
            <p class="section-title" style="margin-top:0;">Vista previa â€” <span id="previewCount">0</span> contactos
              detectados</p>
            <div class="table-wrap" style="max-height:200px;overflow-y:auto;">
              <table>
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>TelÃ©fono</th>
                    <th>Nota</th>
                  </tr>
                </thead>
                <tbody id="previewBody"></tbody>
              </table>
            </div>
            <div class="row" style="margin-top:10px;">
              <button id="importConfirmBtn">âœ… Agregar todos (importar)</button>
              <button id="importCancelBtn" class="secondary">âœ• Cancelar</button>
            </div>
          </div>
        </div>

        <!-- CONTACTS TABLE -->
        <div class="table-wrap" style="margin-top:16px;">
          <table>
            <thead>
              <tr>
                <th>Nombre</th>
                <th>TelÃ©fono</th>
                <th>Nota</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="contactsBody"></tbody>
          </table>
        </div>
        <div id="contactsPagination" class="pagination" style="display:none">
          <button id="prevPageBtn" class="secondary">â† Anterior</button>
          <span id="pageInfo" class="muted">PÃ¡gina 1 de 1</span>
          <button id="nextPageBtn" class="secondary">Siguiente â†’</button>
        </div>
      </section>

    </section>
  </main>

  <button id="floatingAddContactBtn" class="floating-add-btn" style="display:none" type="button">ï¼‹</button>

  <!-- ADD CONTACT MODAL -->
  <div id="addContactModal" class="edit-modal" style="display:none">
    <div class="edit-card">
      <button id="addCloseBtn" class="edit-close-btn" type="button" aria-label="Cerrar">âœ•</button>
      <h3>Agregar contacto</h3>
      <div class="edit-form">
        <label for="addNameInput">Nombre</label>
        <input id="addNameInput" type="text" placeholder="Nombre" />

        <label for="addPhoneInput">TelÃ©fono</label>
        <input id="addPhoneInput" type="text" placeholder="+51999999999" />

        <label for="addNoteInput">Nota</label>
        <input id="addNoteInput" type="text" placeholder="Nota (opcional)" list="noteOptions" />
      </div>
      <button id="addSaveBtn" type="button">ğŸ’¾ Guardar contacto</button>
    </div>
  </div>

  <!-- EDIT CONTACT MODAL -->
  <div id="editContactModal" class="edit-modal" style="display:none">
    <div class="edit-card">
      <button id="editCloseBtn" class="edit-close-btn" type="button" aria-label="Cerrar">âœ•</button>
      <h3>Editar contacto</h3>
      <div class="edit-form">
        <label for="editNameInput">Nombre</label>
        <input id="editNameInput" type="text" placeholder="Nombre" />

        <label for="editPhoneInput">TelÃ©fono</label>
        <input id="editPhoneInput" type="text" placeholder="+51999999999" />

        <label for="editNoteInput">Nota</label>
        <input id="editNoteInput" type="text" placeholder="Nota (opcional)" list="noteOptions" />
      </div>
      <button id="editSaveBtn" type="button">ğŸ’¾ Guardar cambios</button>
    </div>
  </div>

  <!-- WHATSAPP MODAL -->
  <div id="whatsappModal" class="edit-modal" style="display:none">
    <div class="edit-card whatsapp-card">
      <button id="whatsappCloseBtn" class="edit-close-btn" type="button" aria-label="Cerrar">âœ•</button>
      <h3 id="whatsappTitle">WhatsApp</h3>
      <p id="whatsappPhone" class="muted whatsapp-phone">-</p>

      <div id="whatsappQrPanel" class="whatsapp-panel" style="display:none">
        <p id="whatsappQrLead" class="muted" style="font-size:13px;">Escanea este QR para vincular WhatsApp.</p>
        <div id="whatsappConnectOk" class="wa-connect-ok" style="display:none;">
          <strong>Cuenta conectada</strong>
          <small id="whatsappLinkedNumber">-</small>
        </div>
        <img id="whatsappQrImg" alt="QR WhatsApp" style="display:none" />
        <small id="whatsappQrHint" class="muted">Cargando estado de WhatsApp...</small>
        <div class="row" style="margin-top:10px;justify-content:flex-start;">
          <button id="whatsappLogoutBtn" type="button" class="secondary" style="display:none;">Cerrar sesiÃ³n</button>
        </div>
      </div>

      <div id="whatsappFormPanel" class="whatsapp-panel" style="display:none">
        <label>Mensajes predeterminados</label>
        <div class="whatsapp-template-create-row">
          <input id="whatsappTemplateInput" type="text" placeholder="Escribe un mensaje predeterminado..." />
          <button id="whatsappTemplateSaveBtn" type="button" class="secondary">ğŸ’¾ Guardar</button>
        </div>
        <div id="whatsappTemplates" class="whatsapp-templates"></div>

        <label for="whatsappMessageInput">Mensaje</label>
        <textarea id="whatsappMessageInput" rows="4" placeholder="Escribe tu mensaje..."></textarea>

        <label>Archivo (opcional)</label>
        <div id="whatsappDropZone" class="whatsapp-drop-zone">
          <div class="drop-zone-content">
            <span class="drop-icon">ğŸ“</span>
            <span id="whatsappFileName" class="drop-text">Arrastra un archivo aquÃ­ o haz clic</span>
          </div>
          <input id="whatsappFileInput" type="file"
            accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation,text/plain,text/csv"
            hidden />
        </div>

        <button id="whatsappSendBtn" type="button">Enviar por WhatsApp</button>
      </div>
    </div>
  </div>

  <!-- QUOTATION MODAL -->
  <div id="quotationModal" class="edit-modal" style="display:none">
    <div class="edit-card quotation-card">
      <button id="quotationCloseBtn" class="edit-close-btn" type="button" aria-label="Cerrar">âœ•</button>
      <h3>Nueva CotizaciÃ³n</h3>
      <p class="muted" style="margin-bottom:10px;">Sin PHP. Se genera y descarga directamente desde el navegador.</p>

      <div class="edit-form quotation-form-grid">
        <label for="qDate">Fecha</label>
        <input id="qDate" type="date" />

        <label for="qCompany">Empresa / RazÃ³n Social</label>
        <input id="qCompany" type="text" placeholder="Empresa" />

        <label for="qRuc">RUC</label>
        <input id="qRuc" type="text" placeholder="RUC" />

        <label for="qPhone">TelÃ©fono</label>
        <input id="qPhone" type="text" placeholder="+51999999999" />

        <label for="qEmail">Correo</label>
        <input id="qEmail" type="email" placeholder="correo@dominio.com" />

        <label for="qAddress">DirecciÃ³n</label>
        <input id="qAddress" type="text" placeholder="DirecciÃ³n" />
      </div>

      <div class="table-wrap quotation-table-wrap">
        <table>
          <thead>
            <tr>
              <th>Servicio / Producto</th>
              <th>Cantidad</th>
              <th>Precio</th>
              <th>Total</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="quotationItemsBody"></tbody>
        </table>
      </div>

      <div class="row" style="margin-top:10px;">
        <button id="quotationAddItemBtn" type="button" class="secondary">ï¼‹ Agregar Ã­tem</button>
      </div>

      <div class="quotation-totals">
        <label class="quotation-igv-label">
          <input id="quotationApplyIgv" type="checkbox" />
          <span>Aplicar IGV (18%)</span>
        </label>
        <div class="quotation-total-line"><span>Subtotal:</span><strong id="quotationSubtotal">S/ 0.00</strong></div>
        <div class="quotation-total-line"><span>IGV:</span><strong id="quotationIgv">S/ 0.00</strong></div>
        <div class="quotation-total-line grand"><span>Total:</span><strong id="quotationTotal">S/ 0.00</strong></div>
      </div>

      <div class="row" style="justify-content:flex-end;">
        <button id="quotationPreviewBtn" type="button" class="secondary">ğŸ‘ï¸ Vista previa</button>
        <button id="quotationDownloadBtn" type="button">ğŸ’¾ Descargar PDF</button>
      </div>
    </div>
  </div>

  <!-- QUOTATION PREVIEW MODAL -->
  <div id="quotationPreviewModal" class="edit-modal quotation-preview-modal" style="display:none">
    <div class="edit-card quotation-preview-card">
      <button id="quotationPreviewCloseBtn" class="edit-close-btn" type="button" aria-label="Cerrar">âœ•</button>
      <div class="quotation-preview-actions">
        <button id="quotationPreviewDownloadBtn" type="button">ğŸ’¾ Descargar PDF</button>
        <span id="quotationSendFeedback" class="quotation-send-feedback" aria-live="polite"></span>
      </div>
      <iframe id="quotationPreviewFrame" class="quotation-preview-frame" title="Vista previa cotizaciÃ³n"></iframe>
    </div>
  </div>

  <datalist id="noteOptions">
    <option value="No contestÃ³"></option>
  </datalist>
  <datalist id="quotationServicesDatalist"></datalist>

  <!-- CALL MODAL -->
  <div id="callModal" class="call-modal" style="display:none">
    <div class="call-card">
      <div class="call-pulse-ring" id="callRing">
        <img src="/logotipo-VCMAS.ico" alt="VC logo" />
      </div>
      <div class="call-card-inner">
        <p class="call-kicker" id="callKicker">Llamando...</p>
        <h3 id="callName">Sin contacto</h3>
        <p class="call-number" id="callNumber">-</p>
        <p class="call-note" id="callNote">-</p>

        <div class="call-meta">
          <span id="callStateBadge" class="badge">idle</span>
          <span id="callDuration" style="font-variant-numeric:tabular-nums;font-weight:600;font-size:16px;">00:00</span>
          <span id="micBadge" class="mic-indicator muted">ğŸ™ï¸ â€”</span>
          <span id="apkAckBadge" class="badge">APK Â· â€”</span>
        </div>

        <div class="call-controls">
          <button id="modalMuteBtn" class="secondary" title="Silenciar micrÃ³fono">ğŸ™ï¸ MicrÃ³fono</button>
          <button id="modalSpeakerBtn" class="secondary" title="Altavoz">ğŸ”Š Altavoz</button>
        </div>

        <div class="call-controls call-controls-main">
          <button id="modalHangupBtn" class="danger">ğŸ“µ Cortar</button>
        </div>

        <small id="callHint" class="muted" style="display:block;margin-top:12px;font-size:12px;"></small>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script type="module" src="/dashboard.js"></script>
</body>

</html>
